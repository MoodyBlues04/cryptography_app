<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSA Visualization</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        hr {
            margin-top: 1rem;
            margin-bottom: 1rem;
            border: 0;
            border-top: 2px solid rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
<div class="container">
    <h2 class="text-center">RSA</h2>

    <a href="/rsa_explanation">Algorithm Explanation</a>

    <div class="row g-3 needs-validation justify-content-center">
        <h3 class="text-center">RSA Parameters</h3>

        <div class="col-md-4">
            <label for="p" class="form-label">P:</label>
            <input type="number" class="form-control" id="p" placeholder="Enter p">
            <div class="invalid-feedback" id="p-error-message">
            </div>
        </div>
        <div class="col-md-4">
            <label for="q" class="form-label">Q:</label>
            <input type="number" class="form-control" id="q" placeholder="Enter q">
            <div class="invalid-feedback" id="q-error-message">
            </div>
        </div>
        <div class="col-md-4">
            <label for="phi" class="form-label">Phi:</label>
            <input type="number" class="form-control" id="phi" placeholder="Enter phi">
            <div class="invalid-feedback" id="phi-error-message">
            </div>
        </div>
        <div class="col-md-4">
            <label for="n" class="form-label">N:</label>
            <input type="number" class="form-control" id="n" placeholder="Enter n">
            <div class="invalid-feedback" id="n-error-message">
            </div>
        </div>
        <div class="col-md-4">
            <label for="e" class="form-label">E:</label>
            <input type="number" class="form-control" id="e" placeholder="Enter e">
            <div class="invalid-feedback" id="e-error-message">
            </div>
        </div>
        <div class="col-md-4">
            <label for="d" class="form-label">D:</label>
            <input type="number" class="form-control" id="d" placeholder="Enter d">
            <div class="invalid-feedback" id="d-error-message">
            </div>
        </div>

        <div class="col-4">
            <button class="btn btn-secondary w-100" type="button" onclick="generateRandomParams()">Generate random
                params
            </button>
        </div>
    </div>

    <hr/>

    <h3 class="text-center">Message</h3>
    <!-- Message Input Area -->
    <div class="d-flex mt-5 mb-3 w-100 row justify-content-center">
        <div class="d-flex justify-content-center align-items-center col-12">
            <label for="message" class="me-2">Message:</label>
            <input type="text" id="message" class="form-control me-2" value="test message" style="width: 300px;">
            <button id="encryptButton" class="btn btn-primary me-2">Encrypt</button>
            <button id="decryptButton" class="btn btn-primary">Decrypt</button>
        </div>
        <div class="d-flex col-8 mt-2">
            <small> For decryption mode please enter encoded numbers via space </small>
        </div>
    </div>
    <div id="visualization" class="mt-4">
    </div>
</div>

<!-- Bootstrap JS and dependencies -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">

<script>
    function chooseRandom(choices) {
        let index = Math.floor(Math.random() * choices.length);
        return choices[index];
    }

    function isPrime(n) {
        if (n <= 1) return false;
        if (n <= 3) return true;
        if (n % 2 === 0 || n % 3 === 0) return false;
        for (let i = 5; i * i <= n; i += 6) {
            if (n % i === 0 || n % (i + 2) === 0) return false;
        }
        return true;
    }

    function gcd(a, b) {
        while (b) {
            [a, b] = [b, a % b];
        }
        return a;
    }

    // todo enter in form
    const LOW_PRIME_BOUND = 0;
    const HIGH_PRIME_BOUND = 3_000;
    let PRIMES = [];
    for (let i = LOW_PRIME_BOUND; i < HIGH_PRIME_BOUND; i++)
        if (isPrime(i))
            PRIMES.push(i)

    function getRandomPrime() {
        return chooseRandom(PRIMES);
    }

    function findE(phi) {
        let e = 2;
        while (e < phi) {
            if (gcd(e, phi) === 1) return e;
            e++;
        }
        throw new Error(`Cannot find E for phi=${phi}`);
    }

    function extendedGcd(a, b) {
        if (a === 0) return [b, 0, 1];
        const [g, y, x] = extendedGcd(b % a, a);
        return [g, x - Math.floor(b / a) * y, y];
    }

    function modInverse(a, m) {
        const [g, x] = extendedGcd(a, m);
        if (g !== 1) throw new Error('modular inverse does not exist');
        return (x % m + m) % m;
    }

    function getGenerationKeyPair() {
        return {publicKey: {n: n, e: e}, privateKey: {n: n, d: Number(d)}};
    }

    let p, q, phi, n, e, d;
    let params = {
        'p': {
            setter: (val) => {
                p = Number(val);
            }
        },
        'q': {
            setter: (val) => {
                q = Number(val);
            }
        },
        'phi': {
            setter: (val) => {
                phi = Number(val);
            }
        },
        'n': {
            setter: (val) => {
                n = Number(val);
            }
        },
        'e': {
            setter: (val) => {
                e = Number(val);
            }
        },
        'd': {
            setter: (val) => {
                d = Number(val);
            }
        },
    };

    const addErrorMessage = (inputId, message) => {
        document.getElementById(inputId).classList.add('is-invalid');
        document.getElementById(`${inputId}-error-message`).textContent = message;
    }
    const removeErrorMessage = (inputId) => {
        document.getElementById(`${inputId}-error-message`).textContent = '';
        document.getElementById(inputId).classList.remove('is-invalid');
    }
    const validateInputs = () => {
        for (const inputId in params) {
            removeErrorMessage(inputId);
        }
        if (!isPrime(p)) {
            addErrorMessage('p', 'P must be prime');
            return false;
        }
        if (!isPrime(q)) {
            addErrorMessage('q', 'Q must be prime');
            return false;
        }
        if (p === q) {
            addErrorMessage('p', 'P and Q must not be equal');
            addErrorMessage('q', 'P and Q must not be equal');
            return false;
        }
        if (n !== p * q) {
            addErrorMessage('n', 'N != P * Q');
            return false;
        }
        if (phi !== (p - 1) * (q - 1)) {
            addErrorMessage('phi', 'PHI != (P - 1) * (Q - 1)');
            return false;
        }
        if (e >= phi || e <= 1) {
            addErrorMessage('e', '1 < E < PHI');
            return false;
        }
        if (gcd(phi, e) !== 1) {
            addErrorMessage('e', 'gcd(E, PHI) != 1');
            return false;
        }
        if (d >= n || e * d % phi !== 1) {
            addErrorMessage('d', 'E * D != 1 (mod PHI). So D is not an inverse of E');
            return false;
        }
        return true;
    };

    for (const inputId in params) {
        let paramData = params[inputId];
        const inputEl = document.getElementById(inputId);
        inputEl.addEventListener('change', () => {
            paramData.setter(inputEl.value);
            validateInputs();
        })
    }

    const generateRandomParams = () => {
        p = Number(getRandomPrime());
        q = Number(0);
        while (q === 0 || q === p) {
            q = Number(getRandomPrime());
        }

        n = p * q;
        phi = (p - 1) * (q - 1);
        e = findE(Number(phi));
        d = modInverse(e, Number(phi));

        validateInputs();
        for (const inputId in params) {
            document.getElementById(inputId).value = eval(inputId);
        }
    }

    const makeResultMessage = (message, visualizationDiv) => {
        const result = document.createElement('input');
        result.value = message;
        result.readOnly = true;
        result.className = 'form-control mb-5';
        result.id = 'result';

        const label = document.createElement('label');
        label.className = 'form-label';
        label.htmlFor = 'result';
        label.innerText = 'Result:';
        visualizationDiv.appendChild(label);
        visualizationDiv.appendChild(result);
    }

    // RSA Decryption and Visualization
    document.getElementById('decryptButton').addEventListener('click', () => {
        if (!validateInputs()) {
            alert('Please, enter correct parameters');
            return;
        }

        const message = document.getElementById('message').value;
        const charCodes = message.split(' ').map((charCode) => parseInt(charCode));
        for (const charCode of charCodes) {
            if (isNaN(charCode)) {
                alert('For decryption, please, enter correct numbers via spaces into message field');
                return;
            }
        }

        const {_, privateKey} = getGenerationKeyPair();
        const {n, d} = privateKey;

        let messageBytes = [];
        for (const encodedCharCode of charCodes) {
            let plaintext = BigInt(encodedCharCode) ** BigInt(d) % BigInt(n);
            const byteLength = Math.ceil(plaintext.toString(2).length / 8);
            const bytes = [];
            for (let i = 0; i < byteLength; i++) {
                bytes.unshift(Number(plaintext & 0xffn));
                plaintext >>= 8n;
            }
            messageBytes.push(...bytes);
        }

        const decryptedMessage = new TextDecoder('utf-8').decode(new Uint8Array(messageBytes));

        const visualizationDiv = document.getElementById('visualization');
        visualizationDiv.innerHTML = '<hr/> <h3 class="text-center">Result</h3>';

        makeResultMessage(decryptedMessage, visualizationDiv);
    });

    // RSA Encryption and Visualization
    document.getElementById('encryptButton').addEventListener('click', () => {
        if (!validateInputs()) {
            alert('Please, enter correct parameters');
            return;
        }

        const message = document.getElementById('message').value;
        const visualizationDiv = document.getElementById('visualization');
        visualizationDiv.innerHTML = '<hr/> <h3 class="text-center">Result</h3>';

        if (!message) {
            alert('Please, enter a message to encrypt.');
            return;
        }

        const {publicKey, _} = getGenerationKeyPair();

        // Create a table for visualization
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        table.appendChild(tbody);

        table.className += ' table table-striped';
        const addRow = (table, rowElements, elType = 'td') => {
            const row = document.createElement('tr');
            rowElements.forEach(elementText => {
                const rowEl = document.createElement(elType);
                rowEl.textContent = elementText;
                row.appendChild(rowEl);
            });
            table.appendChild(row);
        }

        const headers = ['#', 'Char', 'Char code', 'Exp = charInt ^ e', 'CipherChar = exp % n'];
        addRow(thead, headers, 'th');

        let encodedMessage = '';

        for (let i = 0; i < message.length; i++) {
            const char = message[i];
            const charInt = char.charCodeAt(0);
            const exp = Number(charInt) ** Number(publicKey.e);
            const cipherChar = Number(exp) % Number(publicKey.n);
            const rowData = [i + 1, char, charInt, exp, cipherChar]
            addRow(tbody, rowData);
            encodedMessage += cipherChar + ' ';
        }

        makeResultMessage(encodedMessage.trim(), visualizationDiv);
        visualizationDiv.appendChild(table);
    });
</script>
</body>
</html>